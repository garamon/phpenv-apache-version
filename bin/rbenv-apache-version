#!/usr/bin/env bash
# Usage: phpenv apache-version <version>

set -e
[ -n "$RBENV_DEBUG" ] && set -x

# Provide rbenv completions
if [ "$1" = "--complete" ]; then
  exec rbenv-versions --bare
fi

PHPENV_APACHE_VERSION="$1"
PHPENV_APACHE_VERSION_FILE="${RBENV_ROOT}/php-apache-version"

DARWIN_HTTPD_NAME="$2"

usage_darwin() {
  echo "$(rbenv-help --usage apache-version) [system | httpd22 | httpd24]" >&2
  echo >&2
  echo "  You need specify which version of apache you use." >&2
  echo "    system: OS bundled httpd (/usr/sbin/httpd)" >&2
  echo "    httpd22: Homebrew httpd22" >&2
  echo "    httpd24: Homebrew httpd24" >&2
  exit 1
}

if [ -n "$PHPENV_APACHE_VERSION" ]; then
  rbenv-version-file-write "$PHPENV_APACHE_VERSION_FILE" "$PHPENV_APACHE_VERSION"
else
  rbenv-version-file-read "$PHPENV_APACHE_VERSION_FILE" ||
  rbenv-help --usage apache-version >&2
  exit 1
fi

OS=`uname`

if [ "$OS" == "Darwin" ]; then
  case $DARWIN_HTTPD_NAME in
    system)
      PHPENV_APACHE_MODULE_PATH=/usr/libexec/apache2
      ;;

    httpd*)
      if command -v brew >/dev/null; then
        if [ -d "$(brew --prefix $DARWIN_HTTPD_NAME 2>/dev/null)" ]; then
          PHPENV_APACHE_MODULE_PATH="$(brew --prefix $DARWIN_HTTPD_NAME 2>/dev/null)/libexec"
        fi
      fi
      ;;
    *)
      usage_darwin
      ;;
  esac
else
  if [ -f /etc/redhat-release ] ; then
    PHPENV_APACHE_MODULE_PATH="/etc/httpd/modules"
  elif [ -f /etc/debian_version ] ; then
    PHPENV_APACHE_MODULE_PATH="/usr/lib/apache2/modules"
  fi
fi

if [ -z "$PHPENV_APACHE_MODULE_PATH" ]; then
  if [ "$OS" == "Darwin" ]; then
    usage_darwin
  else
    echo "Sorry your OS is not supported." >&2
    exit 1
  fi
fi

PHPENV_PREFIX_PATH="${RBENV_ROOT}/versions/${PHPENV_APACHE_VERSION}"

if [[ $PHPENV_APACHE_VERSION =~ ^5 ]]; then
  PHP_MODULE_PATH="${PHPENV_PREFIX_PATH}/libphp5.so"
elif [[ $PHPENV_APACHE_VERSION =~ ^7 ]]; then
  PHP_MODULE_PATH="${PHPENV_PREFIX_PATH}/libphp7.so"
fi

if [ ! -f "$PHP_MODULE_PATH" ]; then
  echo "Make sure the specified version is installed." >&2
  echo "Apache module not found ${PHP_MODULE_PATH}" >&2
  exit 1
fi

echo "copy ${PHP_MODULE_PATH} to ${PHPENV_APACHE_MODULE_PATH}"
sudo cp -p "$PHP_MODULE_PATH" "$PHPENV_APACHE_MODULE_PATH"

echo "Restarting apache..."

if [ "$OS" == "Darwin" ]; then
  case $DARWIN_HTTPD_NAME in
    system)
      DARWIN_HTTPD_APACHECTL=/usr/sbin/apachectl
      ;;

    httpd*)
      DARWIN_HTTPD_APACHECTL=$(brew --prefix $DARWIN_HTTPD_NAME)/bin/apachectl
      ;;
  esac
  sudo $DARWIN_HTTPD_APACHECTL -k restart
else
  if [ -f /etc/redhat-release ] ; then
    sudo service httpd restart
  elif [ -f /etc/debian_version ] ; then
    sudo service apache2 restart
  fi
fi
